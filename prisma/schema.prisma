generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String      @id @default(uuid())
  telegramId          BigInt      @unique
  username            String?
  solanaAddress       String?
  createdAt           DateTime    @default(now())
  wagers              Wager[]
  challengesSent      Challenge[] @relation("ChallengerChallenges")
  challengesReceived  Challenge[] @relation("OpponentChallenges")
  houseBets           HouseBet[]
}

model Game {
  id         String      @id @default(uuid())
  externalId String      @unique
  sport      Sport
  homeTeam   String
  awayTeam   String
  homeScore  Int?
  awayScore  Int?
  startTime  DateTime
  status     GameStatus  @default(SCHEDULED)
  winner     String?
  // Odds data (American format, e.g. -110, +150)
  homeMoneyline   Int?
  awayMoneyline   Int?
  homeSpread      Float?
  awaySpread      Float?
  spreadOdds      Int?      // Usually -110
  totalLine       Float?    // Over/under line
  overOdds        Int?
  underOdds       Int?
  oddsUpdatedAt   DateTime?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  rounds          Round[]
  challenges      Challenge[]
  houseBets       HouseBet[]
}

// Bet types for house betting
enum BetType {
  MONEYLINE
  SPREAD
  TOTAL_OVER
  TOTAL_UNDER
}

// Bets placed against the house (treasury)
model HouseBet {
  id              String    @id @default(uuid())
  gameId          String
  game            Game      @relation(fields: [gameId], references: [id])
  userId          String
  user            User      @relation(fields: [userId], references: [id])
  chatId          BigInt
  betType         BetType
  pick            String    // "home", "away", "over", "under"
  odds            Int       // The odds at time of bet (American format)
  line            Float?    // Spread or total line at time of bet
  amount          BigInt    // Wager amount in lamports
  potentialWin    BigInt    // Calculated payout if won
  // Unique deposit wallet per bet
  depositAddress    String?   @unique
  depositSecretKey  String?   // Encrypted - swept to treasury after confirmation
  txSignature       String?   // Deposit transaction
  status            HouseBetStatus @default(PENDING)
  result            HouseBetResult?
  payoutTx          String?   // Payout transaction if won
  createdAt         DateTime  @default(now())
  settledAt         DateTime?

  @@index([gameId])
  @@index([userId])
  @@index([status])
}

enum HouseBetStatus {
  PENDING     // Waiting for deposit
  ACTIVE      // Deposit confirmed, bet is live
  SETTLED     // Game ended, bet resolved
  CANCELLED   // Bet cancelled (no deposit, game cancelled, etc)
}

enum HouseBetResult {
  WIN
  LOSS
  PUSH        // Tie on spread/total
}

model Round {
  id              String      @id @default(uuid())
  gameId          String
  game            Game        @relation(fields: [gameId], references: [id])
  chatId          BigInt
  walletAddress   String      @unique
  walletSecretKey String
  status          RoundStatus @default(OPEN)
  totalPot        BigInt      @default(0)
  createdAt       DateTime    @default(now())
  expiresAt       DateTime
  settledAt       DateTime?
  wagers          Wager[]
  challenges      Challenge[]

  @@index([gameId])
  @@index([chatId])
  @@index([status])
}

model Wager {
  id          String   @id @default(uuid())
  roundId     String
  round       Round    @relation(fields: [roundId], references: [id])
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  teamPick    String
  amount      BigInt
  txSignature String?
  paidOut     Boolean  @default(false)
  payoutTx    String?
  createdAt   DateTime @default(now())

  @@index([roundId])
  @@index([userId])
}

model Treasury {
  id        String   @id @default(uuid())
  totalFees BigInt   @default(0)
  updatedAt DateTime @updatedAt
}

model Challenge {
  id                String          @id @default(uuid())
  gameId            String
  game              Game            @relation(fields: [gameId], references: [id])
  chatId            BigInt
  challengerId      String
  challenger        User            @relation("ChallengerChallenges", fields: [challengerId], references: [id])
  challengerTeam    String          // "home" or "away"
  opponentId        String
  opponent          User            @relation("OpponentChallenges", fields: [opponentId], references: [id])
  amount            BigInt          // Agreed amount in lamports
  status            ChallengeStatus @default(PENDING)
  roundId           String?         // Links to round once accepted
  round             Round?          @relation(fields: [roundId], references: [id])
  createdAt         DateTime        @default(now())
  expiresAt         DateTime        // Challenge expires if not accepted

  @@index([chatId])
  @@index([challengerId])
  @@index([opponentId])
  @@index([status])
}

enum ChallengeStatus {
  PENDING
  ACCEPTED
  DECLINED
  EXPIRED
}

enum Sport {
  // US Major Sports
  NBA
  NFL
  NHL
  MLB
  WNBA
  // College
  NCAAF
  NCAAB
  // Combat Sports
  MMA
  // Soccer
  EPL
  MLS
  LALIGA
  SERIEA
  BUNDESLIGA
  LIGUE1
  UCL
  // Esports
  CS2
  LOL
  DOTA2
}

enum GameStatus {
  SCHEDULED
  LIVE
  FINAL
  CANCELLED
  POSTPONED
}

enum RoundStatus {
  OPEN
  LOCKED
  SETTLED
  CANCELLED
}
